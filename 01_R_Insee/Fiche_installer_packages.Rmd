# Comment installer des _packages_ ?

::: {.recommandation data-latex=""}
IL FAUT ECRIRE DES RECOMMANDATIONS.
- Utiliser `install.packages` ;
- Faire attention à utiliser une librairie sur laquelle on a les droits en écriture ;
- L'installation manuelle est réservée à des usages vraiment spécifiques.
:::

## Qu'est-ce qu'un _package_ et où les trouve-t-on ?

Un _package_ est une extension des fonctionnalités de base de `R`. Il est constitué d'objets `R` (la plupart du temps des fonctions, parfois des données) empaquetés en un seul fichier, dans le but d'être partagé facilement entre utilisateurs.

Les _packages_ sont au coeur de la logique collaborative de `R`. Ils permettent de bénéficier des contributions d'autres utilisateurs de `R` et de partager avec d'autres des fonctionnalités utiles. A ce jour, il existe plus de 14 000 _packages_ disponibles pour `R`, qui proposent des fonctions pour réaliser une multitude de tâches. Il est donc primordial de savoir où chercher les _packages_ et comment les installer.

DETAILLER ICI LA NOTION DE DEPOT, ET LA NOTION DE DEPENDANCES.


## Installer depuis un dépôt de _packages_ distant

La façon la plus commune (et commode) d'installer un _package_ est d'utiliser la fonction `install.packages`. Cette fonction s'utilise de la façon suivante :

```{r, eval = FALSE}
install.packages("mon_beau_package")
```

Cette fonction réalise successivement deux actions :

1. ELle télécharge la dernière version du _package_ sur un dépôt distant de _packages_ R (typiquement le dépôt officiel) ;
2. Elle installe le _package_ sur la machine de l'utilisateur.

Trois points sont à noter sur l'utilisation de la fonction `install.packages` :
- Les noms des _packages_ sont sensibles à la casse : il est important de bien respecter majuscules et minuscules. Par exemple, la commande `install.packages(Ggplot2)` ne fonctionnera pas, car le _package_ s'appelle en réalité `ggplot2` (en minuscules).
- Cette fonction accepte en paramètre un vecteur de noms de _packages_, afin d'installer plusieurs _packages_ en une seule instruction :
    ```{r, eval = FALSE}
    install.packages(c("package1", "package2", "package3"))
    ```
- Un _package_ est installé **de façon permanente** sur la machine. Cela signifie que l'installation n'est à réaliser qu'une seule fois (sauf si on souhaite mettre à jour le _package_ par la suite).

::: {.remarque data-latex=""}
Si les _packages_ sont _installés_ une fois pour toutes, il reste néanmoins nécessaire de les _charger_ **à chaque utilisation** avec `library(...)`. Ceci rend ses fonctionnalités disponibles dans la session `R` en cours. Pour éviter des réinstallations superflues, les programmes R ne contiennent en génral pas les instructions d'installation des _packages_, mais seulement les instructions de chargement en début.
:::

Un _package_ repose la plupart du temps sur d'autres _packages_ pour fonctionner. Ces _packages_ sont appelés **dépendances**. Par défaut, `install.packages` installe également toutes les dépendances nécessaires. Ce comportement est modifiable via l'argument `dependencies`.


#### Choix du dépôt

Par défaut, la fonction `install.packages` télécharge le _package_ demandé sur le dépôt officiel du projet `R`, le [CRAN](https://cran.r-project.org) (_Comprehensive R Archive Network_). Le CRAN dispose de plusieurs copies exactes de son contenu. Ces copies, appelées _miroirs_, sont la plupart du temps hébergés sur des [serveurs d'universités ou d'établissements de recherche](https://cran.r-project.org/mirrors.html). Télécharger un _package_ sur un miroir ou un autre est strictement équivalent. L'intérêt de choisir un miroir proche de sa localisation est uniquement de limiter les flux de données sur le réseau.

Pour connaître le dépôt qui sera utilisé par défaut lors d'une installation :
```r
getOption("repos")
```
Il est également possible de spécifier le dépôt grâce à l'argument `repos` de `install.packages`.

::: {.remarque data-latex=""}

À l'Insee, les _packages_ installés sur **AUS** sont récupérés sur un dépôt accessible seulement en interne, https://nexus.insee.fr. Ce dépôt permet de contourner le fait qu'internet ne soit pas accessible depuis AUS. Il est actualisé sur le CRAN quotidiennement.

Ce dépôt diffère des miroirs listés sur le CRAN par les aspects suivants :

- il n'est accessible que depuis le réseau Insee ;
- il peut héberger des _packages_ développés en interne et ajoutés sans passer être soumis au CRAN.

Sur AUS, `R` est configuré de manière à chercher automatiquement les _packages_ sur ce dépôt interne. En local sur un poste Insee, on peut aussi y accèder comme n'importe quel miroir (option ou argument `repos`) :

```r
# spécifier le dépôt Insee à chaque installation
install.packages("package1", repos = "https://nexus.insee.fr/repository/r-public")

# pour conserver le réglage
options(repos = "https://nexus.insee.fr/repository/r-public")
# ce qui permet d'omettre `repos` pour toute la session R
install.packages("package1")
```
:::

### Type de _packages_

<!-- à compléter (source vs win.binary et Rtools) -->

### Installer depuis une forge logicielle (GitHub, GitLab...)

Certains _packages_ sont mis à disposition sur une [forge logicielle](https://fr.wikipedia.org/wiki/Forge_%28informatique%29), par exemple GitHub ou GitLab.

<!--
Raisons pour lesquelles tous les _packages_ pas sur le CRAN

- seulement les versions stables
- processus de soumission plus complexe, effort de maintenance
- _package_ trop spécifique (exemple : outil purement Insee)
- ...
-->

Le _package_ `remotes` a pour la finalité principale d'installer des _packages_ depuis des forges logicielles.

```r
library(remotes)
```

Pour installer un _package_ depuis une forge, utiliser la fonction dédiée : `install_github` pour GitHub, `install_gitlab` pour GitLab, `install_svn` pour SVN, etc...

Exemples :

```r
install_github("InseeFrLab/doremifasolData")
# installe depuis `https://github.com/InseeFrLab/doremifasolData`
```

```r
install_gitlab("py_b/funprog")
# installe depuis `https://gitlab.com/py_b/funprog`
#   TODO: chercher un _package_ plus connu !
```

Seul le premier argument (`repo`) est obligatoire. Il est formé nom de l'utilisateur sur la forge suivi du nom du dépôt. Le _package_ installé contiendra les modifications les plus récentes. Installer depuis une forge permet ainsi de récupérer la version de développement d'un _package_ (seules les versions stables sont en général soumises au CRAN). Pour installer un _package_ tel qu'il était à un moment donné, il est également possible de faire suivre le nom du dépôt par une référence à un commit, un tag ou une branche. Exemples : `install_gitlab("py_b/funprog@v-0.3.0")`

Les fonctions créeront une archive temporaire (.tar.gz) et installeront le _package_ à partir de celle-ci. Pour les raisons évoquées plus haut, ceci implique que `Rtools` soit disponible (sous Windows).

Par défaut, ces fonctions installent depuis la forge officielle (github.com pour Github, gitlab.com pour GitLab, ...). Il est aussi possible pour une entreprise ou organisation de créer sa propre instance de forge. Ainsi, l'Insee dispose de la forge https://gitlab.insee.fr. Pour modifier l'instance où sera recherché le dépôt, utiliser l'argument `host` :

```r
install_gitlab(repo = "py_b/fmtsas", host = "gitlab.insee.fr")
# installe depuis `https://gitlab.insee.fr/py_b/fmtsas`
#   TODO: chercher un autre _package_ ?
```

::: {.remarque data-latex=""}
Sur AUS, l'installation depuis des dépôt hébergés sur internet n'est pas possible. En revanche, on peut accéder à gitlab.insee.fr.
:::

### Installer depuis un fichier

Il est aussi possible d'installer un _package_ depuis une archive compressée (fichiers ".zip" pour les binaires Windows ou ".tar.gz" pour les _packages_ _source_).

```r
install.packages("chemin/en/local/package1_x.y.z.zip", repos = NULL)
```
Pour indiquer que la source est un fichier local, il est obligatoire de spécifier `repos = NULL`.

Si le fichier est de type "source" (extension .tar.gz), Rtools peut là encore s'avérer nécessaire, notamment si certaines fonctions sont écrites en C ou C++.

Cette solution sera utilisée dans les cas suivants : 

- le _package_ n'est pas sur un dépôt distant (CRAN ou une forge logicielle)
- on souhaite installer une version plus ancienne que celle actuellement sur le dépôt distant
- aucune connexion internet n'est possible (par exemple, transmission du fichier compressé via une clé usb)

Il est à noter que cette méthode atteint rapidement ces limites dès lors que des dépendances pas encore installées sont requises.

### Emplacement des _packages_ installés

Par défaut, les _packages_ sont installés :

- **sur poste** : dans le sous-dossier "library" de l'emplacement où est installé `R` ;
- **sur AUS** : sur son espace personnel, dans le dossier `U:/R/win-library/x-y`, où `x-y` désigne le numéro de version de `R`.

Dans les deux cas, les _packages_ sont associés à une version particulière de `R`. Ainsi, installer un _package_ depuis une version différente de R installera les _packages_ dans un dossier distinct. Dans cette configuration, passer à une nouvelle version de R requerra notamment d'avoir à réinstaller les _packages_.

Ce classement limite les risques d'incompatibilité entre versions de R et versions des _packages_. En effet, certains _packages_ ont besoin d'une version minimale de `R` pour fonctionner.

Pour connaître les répertoires où sont recherchés les _packages_ à charger, utiliser l'instruction `.libPaths()`. Il est possible de modifier cet emplacement, voire de définir plusieurs emplacements où les _packages_ seront successivement recherchés lors de l'appel à `library()` (sous réserve d'avoir accès en écriture au dossier).

Changer `libPaths` est cependant une pratique avancée, à déconseiller si on veut s'éviter tout problème de compatibilité entre versions.

### Mettre à jour les _packages_

Pour savoir s'il existe une version plus récente des _packages_ installés sur sa machines, utilser la fonction `old.packages`. Cette fonction renvoie un tableau contenant notamment la version installée et la version disponible sur le dépôt distant.

Pour se voir offrir la possibilité de les mettre effectivement à jour, utiliser la fonction `update.packages`. Par défaut, cette fonction demande une confirmation avant de procéder à l'installation d'un _package_ obsolète.

### Gestion des _packages_ avec RStudio

`RStudio` dispose d'un onglet "Packages" (par défaut dans le cadran en bas à droite) où l'on peut gérer les _packages_ sans saisir des instructions dans la console. Les fonctionnalités principales sont les suivantes :

- affichage des _packages_ installés sur le système (correspond au résultat de la fonction `installed_packages`). Cocher un _package_ dans cette liste le charge en mémoire (`library`).
- bouton "Install" permet de chercher un _package_ sur le CRAN (ou un autre dépôt) ou de sélectionner un _package_ sous forme de fichier. L'auto-complétion sur le nom du _package_ est proposée lors de la recherche, ce qui la rend plus aisée et prévient les problèmes de casse (majuscules / minuscules).
- bouton "Update" permet de lister les _packages_ pour lesquels il existe une version plus récente et d'éventuellement les mettre à jour.

Chacune de ces manipulations effectuées par l'intermédiaire de l'interface graphique génère (et exécute) la commande correspondante dans la console.

Lors de l'ouverture d'un script, `RStudio` tente aussi de détecter automatiquement si les _packages_ utilisés dans celui-ci sont installés. Dans le cas contraire, il affiche un bandeau en haut du script proposant d'installer les _packages_ manquants :
`▲ _package_ --- required but is not installed. Install Don't show again`

::: {.remarque data-latex=""}
Sur **AUS**, ne pas installer les _package_ à partir de ce bandeau. RStudio essaie en effet de télécharger depuis le CRAN, qui n'est pas accessible depuis AUS).
:::


<!-- 

# Installer des _packages_

L'utilisateur souhaite installer des _packages_. Cette fiche doit aller avec les fiches "Comment gérer ses dépendances", 

## Un plan très rapide

### En vrac, les élements qu'il va falloir définir à un moment
- c'est quoi un _package_?
- distinction source/binary
- c'est quoi un repo? Nexus, Cran, Github/Gitlab.
- c'est quoi Rtools? Comment savoir si `R` sait où trouver Rtools?
- c'est quoi une librairie?
- `.libPaths()`.
- C'est quoi une dépendance de _package_?

### Introduction aux _packages_

#### C'est quoi un _package_?

Traduire des éléments existants en anglais, et donner quelques exemples. Expliquer pourquoi on doit installer des _packages_ et que les _packages_ sont au coeur de la logique collaborative de `R`.

#### Qu'est-ce qu'une dépendance?

Traduire des éléments existants en anglais, et donner quelques exemples.

Remarque: utiliser beaucoup de _packages_ fragilise le code. Il faut bien réfléchir avant d'ajouter un _package_ à un projet. Renvoi à la future fiche sur la gestion des dépendances.

#### Où trouve-t-on des _packages_?

Introduire la notion de `repo`: CRAN ou Github.

### Comment installer un _package_ issu du CRAN?

- Expliquer qu'on n'a pas accès à Internet, et l'existence du Nexus.
- Préciser que `install.packages()` installe par défaut la dernière version disponible du _package_.
- Comment utiliser `install.packages()` et ses options: `repo`, `lib` et `dependencies`.
- Bien expliquer que dans AUS il faut installer le _package_ dans un répertoire sur lequel on a les droits en écriture. Expliquer `.libPaths` le cas échéant.

### Quelques situations particulières

#### Comment utiliser un _package_ disponible uniquement sur Github?

On peut expliquer facilement comment le faire sur le SSP Cloud. Je ne sais pas si on veut donner une méthode pour le faire dans AUS. On peut peut-être dire que c'est techniquement possible (bien que complexe), mais que ce n'est pas recommandé pour des raisons de sécurité.

#### Comment installer une version particulière d'un _package_?

C'est une utilisation avancée. On peut installer une version particulière un _package_ en faisant une installation manuelle:

- Télécharger la version souhaitée du _package_ en source concerné sur le CRAN.
- Installer ce _package_ avec `install.packages` et `repos = NULL`, en spécifiant bien la librairie.

## Fin du plan temporaire

-->

# Utiliser `Git` avec RStudio

Cette fiche n'a pas vocation à présenter de manière extensive `Git`, langage
qui, par sa richesse, mérite à lui seul un ouvrage dédié. Le lecteur sera
ainsi régulièrement renvoyé vers des éléments plus détaillés, notamment
la formation *Travail collaboratif avec R*.

Cette fiche vise à présenter l'utilisation courante de `Git` pour
un utilisateur de `R` et à formuler quelques conseils et recommandations.
L'exaustivité n'est pas recherchée. 

Le parti pris de présenter en priorité l'interface Rstudio est qu'elle facilite
l'appropriation de la gymnastique Git. L'ensemble des gestes présentés dans 
cette fiche peuvent être effectués sans recourir à une interface graphique. Pour
les utilisateurs intéressés par une telle approche, le nom de l'opération
git en question sera systématiquement donné. Pour un débutant, il est néanmoins
recommandé de privilégier l'interface graphique qui facilite les premiers pas. 
A mesure que l'on devient plus confiant, on tend à utiliser de plus en plus
la ligne de commande jusqu'à ne plus vouloir s'en passer.


## Tâches concernées et recommandations

L'utilisateur souhaite utiliser l'outil `Git` pour contrôler l'évolution
de son projet `R`. Cette fiche suppose que les éléments de configuration
de `Git`, présentés dans la Fiche XXXX, sont fonctionnels. 

::: {.recommandation data-latex=""}

* Utiliser `Git` pour tout projet `R` intégrant des codes, des
* Ne pas utiliser `Git` pour les données
* Pour les tâches courantes, privilégier l'interface Rstudio
:::

## Vocabulaire

forge
clone
commit
dépôt local
pull
push

## Principe de Git

`Git` est un outil formidable pour gérer l'évolution d'un projet impliquant
du code informatique (`R` ou un autre langage) ou simplement archiver
l'évolution de scripts sur lesquels on peut vouloir revenir dans un futur
plus ou moins lointain ou dont on peut vouloir piocher une partie pour un
autre projet. Si vous n'êtes pas encore convaincu,
une liste plus longue des raisons d'utiliser Git est
[disponible ici](https://linogaliana.gitlab.io/collaboratif/git.html#pourquoi-utiliser-la-gestion-de-version)

Pour résumer, l'objectif de `Git` est de favoriser une collaboration efficace
avec d'autres personnes mais aussi avec votre premier collaborateur, votre
*moi* futur. `Git` permet d’archiver et de retracer les évolutions d’un code
ligne à ligne, et de travailler à plusieurs sur le même code de façon cohérente. 


## Utiliser Git avec `R` dans un projet `Rstudio`

Il est possible de connecter un projet `Rstudio` a tout moment avec `Git`, que
ce soit à la création de celui-ci ou, si cela n'a pas été fait lors de la
création, plus tard

::: {.recommandation data-latex=""}

* Au lancement d'un projet, il est recommandé de créer un dépôt vide sur une
forge (`Gitlab`, `Github`...) et de le cloner pour disposer d'une copie de
travail en local. Ceci est développé dans la Section XXX
* Si un projet n'a pas été initialisé avec `Git`, taper dans la console de
`R` la commande `usethis::use_git`. Ceci est développé dans la Section XXX
* Ajouter, pour avoir la conscience tranquille, quelques lignes au
fichier `.gitignore` afin d'éviter de mettre des fichiers de données
sous contrôle de version : `*.csv`, `.xls`, `sas7bdat`... Ceci est développé dans la Section XXX
:::


### A l'initialisation d'un projet

[On mettra le lien vers la vidéo de travail collab quand elle existera]

::: {.remarque data-latex=""}

Les exemples de cette partie utilisent l'url du dépôt de la documentation
`utilitR`. Il est tout à fait possible de s'exercer sur ce dépôt pour
effectuer les manipulations de la Section XX et XX qui s'effectuent
sur une copie locale (`clone`) du dépôt.

Néanmoins, il sera
impossible d'effectuer une opération `push` car cela nécessite des droits
d'écriture sur le dépôt qui est réservée aux mainteneurs de la documentation. 
Pour pratiquer ces opérations, il est recommandé de se créer un dépôt personnel
sur `Github` ou `Gitlab`
:::


**Etape 1: Récupérer l'url du dépôt**

En premier lieu, se rendre sur la page du projet qu'on désire récupérer
sur la forge.

Il est nécessaire de récupérer l'adresse du dépôt `Git` en question. Cette 
adresse se termine toujours par `.git`. Ce n'est donc pas l'adresse qui 
s'affiche dans le navigateur quand on se rend sur la forge. Pour afficher
l'adresse en question, qu'on se trouve sur `Github` ou `Gitlab`, il faut
cliquer sur un bouton déroulant à droite. 

Sur `Gitlab`, il s'agit du bouton `Clone`:

```{r, echo = FALSE}
include_image("./pics/git/create_project_0b.png")
```

Sur `Github`, il s'agit du bouton `Code`:

```{r, echo = FALSE}
include_image("./pics/git/create_project_0.png")
```

Choisir la méthode d'authentification désirée, `SSH` ou `HTTPS`
(cf. fiche XXXX). Par la suite, nous allons supposer qu'on utilise une 
authentification `HTTPS`


**Etape 2: Créer le projet Rstudio**


Lorsqu'on créé un projet `Rstudio` (voir fiche XXXX), choisir la troisième
option

```{r, echo = FALSE}
include_image("./pics/git/create_project_1.png")
```

Dans la fenêtre qui apparaît, coller l'url récupéré précedemment dans le 
premier champ:

```{r, echo = FALSE}
include_image("./pics/git/create_project_2.png")
```

Le troisième champ définit la localisation de la copie dans l'aborescence 
de l'ordinateur. Il est possible de la changer en cliquant sur le bouton 
`Browse`.

Après avoir validé, `Rstudio` ouvre un projet `Rstudio` (ou le crée s'il 
n'existait pas dans le dépôt `Git` disponible en ligne). Un nouvel onglet,
portant logiquement le nom de `Git`, apparaît à droite:

```{r, echo = FALSE}
include_image("./pics/git/create_project_3.png")
```

C'est grâce à celui-ci que la plupart des opérations `Git` pourront être
effectuées, ce qui est présenté à partir de la Section
[Premiers pas en local](#git-local)

### Ajouter `Git` à un dépôt déjà existant

Le package `usethis` propose de nombreuses fonctions utiles lorsqu'on
désire configurer un projet RStudio. En tapant la commande 

```{r, eval = FALSE}
usethis::use_git
```

dans la commande, tous les fichiers de configuration nécessaires au bon
fonctionnement de `Git` dans le projet sont ainsi créés. Au passage,
un premier `commit` (voir Section XX) est effectué pour valider 
la création des fichiers adéquats. 

## Premiers pas en local {#git-local} 

Lorsqu'on désire enregistrer les modifications faites à un ou plusieurs
fichiers, il sera nécessaire d'effectuer deux étapes en ligne de
commande :

* `git add`: introduire les lignes en question dans l'*index* de `Git`, sorte
de salle d'attente des modifications à valider
* `git commit`: valider les dernières modifications présentes dans l'*index*
pour les faire connaître (par votre futur moi ou quelqu'un désirant suivre
l'évolution d'un fichier)

C'est pour cette raison que dans RStudio, il faudra procéder en deux temps:
cela respecte la logique du langage `Git`

### Valider les modifications d'un fichier

Supposons qu'un fichier source a été validé et qu'on désire valider ces
modifications. Ci-dessous, le dépôt comporte plusieurs fichiers modifiés.

```{r}
include_image("./pics/git/onglet_git1.png")
```

Le statut du fichier n'est pas le même pour tous les fichiers:

* `M`: le fichier a déjà été au moins une fois ajouté à l'*index* (`git add`)
* `??`: le fichier n'a jamais été ajouté à l'*index* =
* `D`: le fichier a été supprimé (ou renommé)

On ne désire valider les modifications que sur le fichier
`03_Fiches_thematiques/Fiche_git_utilisation.Rmd` et ajouter le fichier
`pics/git/ibglet_git1.png`. 

**Etape 1: Cocher la case vide pour l'étape `add`**

La première étape (`add`) consiste à ajouter cliquer sur la case vide pour
ajouter les fichiers à l'index.

Cela change le statut des fichiers:

```{r}
include_image("./pics/git/onglet_git3.png")
```

Les modifications en question sont dans
la salle d'attente. Il convient maintenant de les officialiser.

**Etape 2: Finaliser l'opération avec `commit`**


Cela se fait en cliquant sur le bouton `Commit`, juste au dessus de la liste 
des fichiers modifiés. En cliquant sur ce bouton, une fenêtre s'ouvre

```{r}
include_image("./pics/git/onglet_git4.png")
```

Les modifications sont résumées, ligne à ligne,
dans la partie inférieure (suppressions en
rouge, ajouts en vert). Pour valider ces modifications (`commit`), il
faut donner un titre au `commit` et cliquer sur le bouton `Commit`.

La modification est validée:

```{r}
include_image("./pics/git/onglet_git5.png")
```

### Consulter l'historique d'un dépôt ou d'un fichier

Il est possible, depuis `Rstudio`, de consulter la liste des modifications
faites à un dépôt en cliquant sur le bouton `History`

```{r}
include_image("./pics/git/onglet_git6.png")
```

Cette action ouvre une fenêtre où chaque `commit` fait sur la branche
(voir plus tard) est listé, avec les modifications concernées.

```{r}
include_image("./pics/git/onglet_git7.png")
```

En ligne de commande, il faudrait taper `git log` pour obtenir une
information équivalente.

## Interagir avec le dépôt

Après avoir effectué des opérations sur son dépôt local, on peut effectuer
deux opérations pour interagir avec le dépôt. Les boutons dans `RStudio` 
illustrent bien l'opération en question :

* `pull` ![](./pics/git/pull.png): récupérer les modifications présentes
sur le dépôt distant ;
* `push` ![](./pics/git/push.png): envoyer les modifications faites en local
sur le dépôt distant.

Pour pouvoir soumettre sa version de travail grâce à un `push`,
il est nécessaire d'avoir un dépôt local à jour
avec la version distante. Cela assure, à tout instant, la cohérence entre
les différentes copies des contributeurs d'un projet. Donc, récupérer la 
dernière version en ligne (`pull`) doit
toujours précéder l'envoi de modifications (`push`). 


::: {.conseil}
Les opérations dans l'onglet `RStudio` sont ordonnées, de gauche à droite,
de manière à représenter la séquence des actions à mettre en oeuvre afin
de publier un code sur un dépôt distant: (add), commit, pull, push

```{r}
include_image("./pics/git/onglet_git7.png")
```
:::

Dans la mesure du possible, lorsqu'il y a eu des modifications sur le dépôt
distant faites par d'autres n'ayant pas été intégrées dans la copie locale, 
`Git` essaiera de fusionner automatiquement les changements. Ce n'est que
si les modifications concernent un même fichier que `Git` refusera la
fusion et vous demandera de vérifier manuellement les morceaux 
de fichiers concernés. Plus de détails sont disponibles dans la 
[formation Travail collaboratif avec R](https://gitlab.com/linogaliana/collaboratif)


## Créer des branches

## Utiliser le terminal

## Pour aller plus loin

* [Formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)
* [*Happy Git with R*](https://happygitwithr.com/)

# Utiliser `Git` avec RStudio

Cette fiche est une introduction à l'usage de `Git` avec `R` et RStudio. Elle présente uniquement les éléments indispensables à un usage courant de `Git`, et formule quelques conseils et recommandations. Elle n'est pas exhaustive, et ne présente pas l'ensemble des fonctionnalités de `Git`. Le lecteur sera ainsi régulièrement renvoyé vers des éléments plus détaillés, notamment la formation *Travail collaboratif avec R*.

Cette fiche décrit l'utilisation de `Git` au travers de l'interface graphique RStudio, qui facilite l'apprentissage de `Git` pour les débutants. Toutefois, utiliser cette interface n'est nullement obligatoire, et il est possible de réaliser l'ensemble des gestes présentés dans cette fiche avec des lignes de commande. Pour les utilisateurs intéressés par une telle approche, le nom de la commande `git` concerné sera systématiquement mentionné.

## Tâches concernées et recommandations

L'utilisateur souhaite utiliser l'outil `Git` pour contrôler l'évolution
de son projet `R`. Cette fiche suppose que les éléments de configuration
de `Git`, présentés dans la Fiche XXXX, sont fonctionnels. 

::: {.recommandation }

**Recommandations générales:** 

* Utiliser `Git` pour tout projet `R` intégrant des codes, des
* Ne pas utiliser `Git` pour les données
* Pour les tâches courantes relatives à `Git`, privilégier
l'interface `RStudio` plutôt que la
ligne de commande

**Recommandation 1 :**

* Au lancement d'un projet, il est recommandé de créer un dépôt vide sur une forge (`Gitlab`, `Github`...) et de le cloner pour disposer d'une copie de travail en local. Ceci est développé dans la
Section [Utiliser `Git` avec `R` dans un projet RStudio](clone-canonical).
* Si un projet n'a pas été initialisé avec `Git`, il est possible de commencer à le suivre avec `Git` en utilisant la commande `usethis::use_git`. Ceci est développé dans la Section
[Ajouter `Git` à un dépôt déjà existant](clone-alternative).
* Ajouter, pour avoir la conscience tranquille, quelques lignes au
fichier `.gitignore` afin d'éviter de mettre des fichiers de données
sous contrôle de version : `*.csv`, `.xls`, `sas7bdat`...
Ceci est développé dans la Section
[Exclure certains fichiers du suivi de modifications](gitignore)

**Recommandation 2 :**

* Il est recommandé d'utiliser RStudio pour créer une branche ou naviguer entre les branches ;
* Il est recommandé d'utiliser les interfaces `Github` ou `Gitlab` pour faire un `merge` entre deux branches. Sur ce point, vous pouvez consulter la [formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)

**Recommandation 3 :**

L'usage de la ligne de commande `Git` est
à utiliser avec tact et mesure :

* Pour les usages courants de `Git`, l'interface graphique de `RStudio` est à privilégier. 
* Pour les usages avancés ou pour les utilisateurs plus experts, la ligne de commande peut être utilisée. Certaines commandes sont néanmoins à proscrire, notamment celles impliquant les termes `force` ou `rebase`.

:::


## Vocabulaire

forge
clone
commit
dépôt local
pull
push

## Pourquoi utiliser `Git`

Tous les statisticiens se sont déjà demandé (ou ont demandé à leurs collègues) :

- quelle était la bonne version d’un programme ;
- qui était l’auteur d’un bout de code en particulier ;
- si un changement était important ou juste un essai ;
- comment fusionner deux versions du même programme modifié par deux personnes différentes ;
- comment travailler à plusieurs sur les mêmes codes...

La réponse à toutes ces questions est : __utiliser `Git`__. `Git` est un outil qui permet de suivre en détail les évolutions d'un projet impliquant du code informatique, et qui facilite l'archivage des codes et la collaboration entre agents. Les avantages de `Git` sont multiples :

- `Git` contient l'historique de toutes les modifications apportées à un fichier ;
- `Git` permet de revenir facilement à une version antérieure d'un fichier ;
- `Git` permet de travailler à plusieurs en même temps sur les mêmes fichiers, de façon cohérente et sans risque de confusion ;
- `Git` permet de proposer des modifications sur des fichiers et les discuter, sans pour autant modifier la dernière version existante...
- `Git` fonctionne avec tous les langages informatiques (`R`, Python, SAS, LaTeX, C/C++, Java, etc.) et n'est pas spécifique à `R`. 

En un mot, **`Git` est le bon outil pour partager des codes et travailler à plusieurs sur un projet statistique (études ou production).** Si vous n'êtes pas encore convaincu,
une liste plus longue des raisons d'utiliser Git est
[disponible ici](https://linogaliana.gitlab.io/collaboratif/git.html#pourquoi-utiliser-la-gestion-de-version).


## Initialiser l'usage de `Git` dans un projet RStudio {#clone}

Il est possible de commencer à suivre avec `Git` les modifications d'un projet `RStudio` à tout moment avec `Git`. **Il est nettement préférable de le faire dès la création du projet**, mais il est possible de le faire plus tard, à n'importe quelle étape du projet.

### Initialiser l'usage de `Git` à la création d'un projet {#clone-canonical}

[On mettra le lien vers la vidéo de travail collab quand elle existera]

::: {.remarque}

Les exemples de cette partie utilisent l'url du dépôt de la documentation `utilitR`. Il est tout à fait possible de s'exercer sur ce dépôt pour effectuer les manipulations de la Section XX et XX qui s'effectuent sur une copie locale (`clone`) du dépôt.

Néanmoins, il sera impossible d'effectuer une opération `push` car cela nécessite des droits d'écriture sur le dépôt qui est réservée aux mainteneurs de la documentation. Pour pratiquer ces opérations, il est recommandé de se créer un dépôt personnel sur `Github` ou `Gitlab`.
:::

**Etape 1 : Créer le dépôt distant**

A ECRIRE

Etape à sauter si le dépôt existe déjà.

**Etape 2 : Récupérer l'url du dépôt distant**

En premier lieu, se rendre sur la page du projet qu'on désire récupérer sur la forge.

Il est nécessaire de récupérer l'adresse du dépôt `Git` en question. Cette adresse se termine toujours par `.git`. Ce n'est donc pas l'adresse qui s'affiche dans le navigateur quand on se rend sur la forge. Pour afficher l'adresse en question, qu'on se trouve sur `Github` ou `Gitlab`, il faut cliquer sur un bouton déroulant à droite. 

Sur `Gitlab`, il s'agit du bouton `Clone`:

```{r, echo = FALSE}
include_image("./pics/git/create_project_0b.png")
```

Sur `Github`, il s'agit du bouton `Code`:

```{r, echo = FALSE}
include_image("./pics/git/create_project_0.png")
```

Choisir la méthode d'authentification désirée, `SSH` ou `HTTPS`
(cf. fiche XXXX). Par la suite, nous allons supposer qu'on utilise une authentification `HTTPS`.


**Etape 3 : Créer un projet RStudio en clonant le dépôt distant**

La troisième étape consiste à créer un projet RStudio (voir fiche XXXX pour plus de détails sur les projets RStudio). Cliquer sur `File > New Project...`, puis †choisissez la troisième option (_Version Control_) :

```{r, echo = FALSE}
include_image("./pics/git/create_project_1.png")
```

Il faut alors renseigner trois champs dans la fenêtre suivante :

- `Repository URL` : coller l'url récupérée précédemment ;
- `Project directory name` : choisir le nom du dossier qui contiendra le projet RStudio ;
- `Create project as subdirectory of :` : définir l'emplacement de votre dépôt local dans l'aborescence de votre poste. Il est possible de la modifier en cliquant sur le bouton `Browse`.

```{r, echo = FALSE}
include_image("./pics/git/create_project_2.png")
```

Après avoir validé, `RStudio` ouvre un projet `RStudio` (ou le crée s'il n'existait pas dans le dépôt `Git` disponible en ligne). Un nouvel onglet portant le nom de `Git` doit normalement apparaître en haut à droite :

```{r, echo = FALSE}
include_image("./pics/git/create_project_3.png")
```

### Initialiser l'usage de `Git` dans un projet RStudio déjà existant {#clone-alternative}

Il est également possible d'ajouter `Git` à un projet RStudio déjà existant. Vous pouvez utiliser cette méthode lorsque vous avez commencé à travailler seul sur un projet `RStudio`, et que vous souhaitez le partager avec des collègues ou mieux suivre les modifications du projet.

**Etape 1 : Initialiser le suivi des modifications du projet RStudio**

La première étape consiste à initialiser l'utilisation de `Git` dans le projet RStudio en exécutant la fonction `usethis::use_git()` du _package_ `usethis`. 

```{r, eval = FALSE}
usethis::use_git()
```

Cette fonction réalise deux opérations : elle crée automatiquement tous les fichiers de configuration nécessaires au bon fonctionnement de `Git` dans le projet sur lequel vous travaillez, et effectue un premier `commit` (voir Section XX) pour valider la création de ces fichiers. 


**Etape 2 : Mettre en place le _remote_**

A REDIGER (LINO: je suis à l'ouest là-dessus)

**Etape 3 : giter tous les codes existants et faire le premier _push_**

A REDIGER (LINO: je suis à l'ouest là-dessus)


### Exclure certains fichiers du suivi de modifications {#gitignore}

Certains fichiers doivent être exclus du suivi des modifications. C'est notamment le cas de fichiers de données ou de fichiers stockant des informations confidentielles (comme les mots de passe, les _tokens_ ou les clés d'API).

Les fichiers exclus du suivi des modifications sont répertoriés dans un fichier nommé `.gitignore`. Si le projet a été créé selon l'une des deux méthodes décrites précédemment, `RStudio` crée automatiquement un fichier `.gitignore` qui contient les lignes suivantes :

~~~r
.Rhistory
.RData
.Rproj.user
~~~

Ce fichier est modifiable et il est souvent nécessaire de lui ajouter des lignes pour exclure un certain nombre de fichiers. Par exemple, vous pouvez ajouter les lignes suivantes pour exclure tous les fichiers csv, SAS et Excel du suivi des modifications :

~~~r
*.csv
*.sas7bdat
*.xls
*.xlsx
~~~

Il est également recommandé d'exclure les fichiers pouvant être produits par des documents `R Markdown` (notamment les fichiers pdf et html). Par exemple, pour exclure les fichiers `PDF` et `HTML`, les lignes suivantes suffisent :

~~~r
*.html
*.pdf
~~~

::: {.conseil}
Le site [https://www.toptal.com/developers/gitignore](gitignore.io) fournit un certain nombre de modèles de fichiers `.gitignore` selon le type de projets associés à `Git`. 
:::


## Premiers pas en local {#git-local} 

Lorsqu'on souhaite enregistrer les modifications faites à un ou plusieurs fichiers, il est nécessaire d'effectuer deux opérations :

* `git add`: sélectionner les modifications qui vont être ajoutées à l'historique des modifications de `Git` (dont le nom technique est *index*) ;
* `git commit`: valider les modifications choisies à l'étape précédente et ajouter une entrée à l'*index* de `Git`.

Les modifications ne seront enregistrées qu'à l'issue de ces deux opérations, que vous pouvez réaliser soit avec la ligne de commande, soit avec l'interface RStudio. La suite de cette section détaille la marche à suivre avec l'interface RStudio.

### Valider les modifications d'un fichier

Supposons qu'un fichier source a été modifié et qu'on désire valider ces
modifications. Ci-dessous, le dépôt comporte plusieurs fichiers modifiés.

```{r, echo = FALSE}
include_image("./pics/git/onglet_git1.png")
```

Le statut du fichier n'est pas le même pour tous les fichiers:

* `M`: le fichier a déjà été au moins une fois ajouté à l'*index* (`git add`) ;
* `??`: le fichier n'a jamais été ajouté à l'*index* =
* `D`: le fichier a été supprimé (ou renommé)

On ne désire valider les modifications que sur le fichier
`03_Fiches_thematiques/Fiche_git_utilisation.Rmd` et ajouter le fichier
`pics/git/ibglet_git1.png`. 

**Etape 1: Cocher la case vide pour l'étape `add`**

La première étape (`add`) consiste à ajouter cliquer sur la case vide pour
ajouter les fichiers à l'index.

Cela change le statut des fichiers:

```{r, echo = FALSE}
include_image("./pics/git/onglet_git3.png")
```

Les modifications en question sont dans
la salle d'attente. Il convient maintenant de les officialiser.

**Etape 2: Finaliser l'opération avec `commit`**


Cela se fait en cliquant sur le bouton `Commit`, juste au dessus de la liste 
des fichiers modifiés. En cliquant sur ce bouton, une fenêtre s'ouvre

```{r, echo = FALSE}
include_image("./pics/git/onglet_git4.png")
```

Les modifications sont résumées, ligne à ligne,
dans la partie inférieure (suppressions en
rouge, ajouts en vert). Pour valider ces modifications (`commit`), il
faut donner un titre au `commit` et cliquer sur le bouton `Commit`.

La modification est validée:

```{r, echo = FALSE}
include_image("./pics/git/onglet_git5.png")
```

### Consulter l'historique d'un dépôt ou d'un fichier

Il est possible, depuis `RStudio`, de consulter la liste des modifications
faites à un dépôt en cliquant sur le bouton `History`

```{r, echo = FALSE}
include_image("./pics/git/onglet_git6.png")
```

Cette action ouvre une fenêtre où chaque `commit` fait sur la branche
(voir plus tard) est listé, avec les modifications concernées.

```{r, echo = FALSE}
include_image("./pics/git/onglet_git7.png")
```

En ligne de commande, il faudrait taper `git log` pour obtenir une
information équivalente.

## Interagir avec le dépôt

Après avoir effectué des opérations sur son dépôt local, on peut effectuer
deux opérations pour interagir avec le dépôt. Les boutons dans `RStudio` 
illustrent bien l'opération en question :

* `pull` ![](./pics/git/pull.png): récupérer les modifications présentes
sur le dépôt distant ;
* `push` ![](./pics/git/push.png): envoyer les modifications faites en local
sur le dépôt distant.

Pour pouvoir soumettre sa version de travail grâce à un `push`,
il est nécessaire d'avoir un dépôt local à jour
avec la version distante. Cela assure, à tout instant, la cohérence entre
les différentes copies des contributeurs d'un projet. Donc, récupérer la 
dernière version en ligne (`pull`) doit
toujours précéder l'envoi de modifications (`push`). 


::: {.conseil}
Les opérations dans l'onglet `RStudio` sont ordonnées, de gauche à droite,
de manière à représenter la séquence des actions à mettre en oeuvre afin
de publier un code sur un dépôt distant: (add), commit, pull, push

```{r, echo = FALSE}
include_image("./pics/git/onglet_git7.png")
```
:::

Dans la mesure du possible, lorsqu'il y a eu des modifications sur le dépôt
distant faites par d'autres n'ayant pas été intégrées dans la copie locale, 
`Git` essaiera de fusionner automatiquement les changements. Ce n'est que
si les modifications concernent un même fichier que `Git` refusera la
fusion et vous demandera de vérifier manuellement les morceaux 
de fichiers concernés. Plus de détails sont disponibles dans la 
[formation Travail collaboratif avec R](https://linogaliana.gitlab.io/collaboratif/)


## Créer des branches

C’est une des fonctionnalités les plus pratiques de la gestion de version.
La création de **branches** dans un projet
(qui devient ainsi un arbre) permet de développer en parallèle des correctifs
ou une nouvelle fonctionnalité sans modifier le dépôt commun. Cela permet de
séparer le nouveau développement et de faire cohabiter plusieurs versions,
pouvant évoluer séparément ou pouvant être facilement rassemblées.
`Git` est optimisé pour le travail sur les branches.

Dans un projet collaboratif, une branche dite `master`
joue le rôle du tronc. C’est autour d’elle que vont pousser ou se greffer
les branches comme le montre l’exemple ci-dessous:

<!---- image à insérer ------>

La partie droite de l'onglet `Git` est consacré aux branches:


```{r, echo = FALSE}
include_image("./pics/git/onglet_git8.png")
```

Cette partie permet de:

1. Créer une nouvelle branche. La branche source, à partir de laquelle la
nouvelle branche diverge, sera celle active au moment de la création. Il est
recommandé de se placer sur `master` avant chaque création de nouvelle branche.
De cette manière, les fusions ultérieures seront facilitées ;
2. Naviguer parmi les branches disponibles
en local - partie `(local branches)` - ou récupérer celles disponibles
sur le dépôt distant - `(remote: origin)`. 

En [ligne de commande](#terminal-git), on
utiliserait la commande `git checkout -b ma-branche` pour créer une nouvelle
branche nommée `ma-branche`. La commande `git checkout ma-branche`
permettrait, quant à elle, de se placer sur cette branche si 
celle-ci existe. 

Lorsqu'on se situe sur une branche, on peut faire les modifications qu'on
désire. Cela n'altère pas la version de référence, celle sur `master`, tant
qu'il n'y a pas de fusion (`merge`). 




## Utiliser le terminal {#terminal-git}


Pour ouvrir un terminal `Git`, cliquer sur l'écrou dans l'onglet `Git`: 

```{r, echo = FALSE}
include_image("./pics/git/onglet_git9.png")
```

Cette action ouvre un terminal `Git bash` permettant de taper :

* des commandes `Linux`, par exemple `ls` (lister les fichiers)
* des commandes `Git`, par exemple `git status` (lister l'état des fichiers
dans `Git`)

```{r, echo = FALSE}
include_image("./pics/git/git-bash.png")
```


L'utilisation de la ligne de commande permet d'aller plus loin qu'avec
l'interface `RStudio`. Grâce à elle, on peut par exemple
corriger une maladresse. Si on s'interdit les commandes qui impliquent
le terme `force` (par exemple `git push force`) ou `rebase`, qui peuvent
créer des conflits de version insolubles avec les collaborateurs,
l'utilisation de la ligne de commande n'est pas plus risquée que l'utilisation
de l'interface `RStudio` (plus de détails 
[Formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)
)

## Pour aller plus loin

* [Formation *Travail collaboratif avec R*](https://linogaliana.gitlab.io/collaboratif/git.html)
* [*Happy Git with R*](https://happygitwithr.com/)
